http = require('http')
path = require 'path'
fs = require 'fs'

class Nor.Application
  
  constructor: (@env) ->
    try
      @env._meta = {_process_start_time: new Date(), status: 200, rendered_view_paths: []}
      for mw in Nor.Middleware._list
        @env = mw.call().process(@env)
        break if @env.finalized is true
    catch ex
      Nor.logger.error ex.message, ex
      @env.res.writeHead(@env._meta.status = 500, 'Content-Type': 'text/html')
      
      view_name = "500.ejs"
      engine = new Nor.ViewRenderer(view_name, layout: false)
      @env.write(engine.render(self: @, ex: ex, env: env))
    finally
      @env.res.end('')
      Nor.Middleware.Logger.process(@env)
  
  @root: ''
  
  @routeRequest: (req, res) ->
    new Nor.Application(new Nor.Env(req, res, req.url))
  
  @boot: ->
    Nor.View.paths.unshift "#{@root}/app/views"
    Nor.routes = new Nor.Routes()
    require "#{@root}/config/routes.coffee"
    require "#{@root}/app/controllers/application_controller.coffee"
  
  @mount: (@port = 3000, @ip = '0.0.0.0') ->
    
    @server = http.createServer(@routeRequest)

    @server.listen(@port, @ip);
    Nor.logger.info("Server running at http://#{@ip}:#{@port}/")