sys = require 'sys'
ejs = require 'ejs'
fs = require 'fs'
path = require 'path'

class Nor.ViewRenderer
  
  constructor: (@view_name, @options = {}) ->
    
  render: (locals = {}) ->
    view = null
    locals['sys'] ||= sys
    locals['req'] ||= locals['env'].req
    locals['debug'] ||= (object) ->
      sys.inspect object
    locals['yield'] ||= (content_for = 'body') ->
      'hello!'
    
    if path.existsSync(@view_name)
      view = @view_name
      
    if view
      return @readAndWrite(view, locals)
    else
      for p in Nor.View.paths
        f = "#{p}/#{@view_name}"
        if path.existsSync(f)
          return @readAndWrite(f, locals)
          
  readAndWrite: (path, locals = {}) ->
    locals['env']._meta.rendered_view_path = path
    ejs.render(fs.readFileSync(path, 'utf-8'), locals: locals)